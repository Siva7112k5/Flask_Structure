{% extends "base.html" %}
{% block title %}All Products - Triowise{% endblock %}
{% block content %}
<div class="products-page">
    <div class="products-layout">
      <!-- Filters Sidebar -->
<aside class="filters-sidebar">
    <h3>Filters</h3>
    
    <!-- Categories - Radio Buttons (Only One Can Be Selected) -->
    <div class="filter-section">
        <h4>Categories</h4>
        <div class="filter-options">
            <!-- "All Categories" option to clear category filter -->
            <label class="filter-radio">
                <input type="radio" name="category" value="" 
                       {% if not filters.category %}checked{% endif %}>
                All Categories
            </label>
            {% for cat in categories %}
            <label class="filter-radio">
                <input type="radio" name="category" value="{{ cat }}" 
                       {% if filters.category == cat %}checked{% endif %}>
                {{ cat }}
            </label>
            {% endfor %}
        </div>
    </div>
    
    <!-- Price Range (unchanged) -->
    <div class="filter-section">
        <h4>Price Range</h4>
        <div class="price-range">
            <input type="number" id="min-price" placeholder="Min" value="{{ filters.min_price or '' }}">
            <span>to</span>
            <input type="number" id="max-price" placeholder="Max" value="{{ filters.max_price or '' }}">
        </div>
        <button class="apply-price">Apply</button>
    </div>
    
    <!-- Brands - Radio Buttons (Only One Can Be Selected) -->
    <div class="filter-section">
        <h4>Brands</h4>
        <div class="filter-options">
            <!-- "All Brands" option to clear brand filter -->
            <label class="filter-radio">
                <input type="radio" name="brand" value="" 
                       {% if not filters.brand %}checked{% endif %}>
                All Brands
            </label>
            {% for brand in brands %}
            <label class="filter-radio">
                <input type="radio" name="brand" value="{{ brand }}"
                       {% if filters.brand == brand %}checked{% endif %}>
                {{ brand }}
            </label>
            {% endfor %}
        </div>
    </div>
    
    <!-- Customer Rating - Radio Buttons (Only One Can Be Selected) -->
    <div class="filter-section">
        <h4>Customer Rating</h4>
        <div class="filter-options">
            <!-- "All Ratings" option to clear rating filter -->
            <label class="filter-radio">
                <input type="radio" name="rating" value="" 
                       {% if not filters.min_rating %}checked{% endif %}>
                All Ratings
            </label>
            <label class="filter-radio">
                <input type="radio" name="rating" value="4"
                       {% if filters.min_rating == '4' %}checked{% endif %}>
                4★ & above
            </label>
            <label class="filter-radio">
                <input type="radio" name="rating" value="3"
                       {% if filters.min_rating == '3' %}checked{% endif %}>
                3★ & above
            </label>
            <label class="filter-radio">
                <input type="radio" name="rating" value="2"
                       {% if filters.min_rating == '2' %}checked{% endif %}>
                2★ & above
            </label>
        </div>
    </div>
    
    <button class="clear-filters">Clear All</button>
</aside>
        <!-- Products Grid -->
        <div class="products-content">
            <div class="products-header">
                <h2>All Products <span class="product-count">({{ products|length }} items)</span></h2>
                <div class="sort-section">
                    <label>Sort by:</label>
                    <select id="sort-select">
                        <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Newest First</option>
                        <option value="price_low" {% if filters.sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price_high" {% if filters.sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                        <option value="rating" {% if filters.sort == 'rating' %}selected{% endif %}>Customer Rating</option>
                    </select>
                </div>
            </div>
            
            <div class="product-grid">
                {% for product in products %}
                <div class="product-card" onclick="location.href='{{ url_for('product_detail', product_id=product.id) }}'">
                    <div class="product-image">
                        <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.name }}">
                        {% if product.discount > 0 %}
                        <span class="discount-badge">{{ product.discount }}% OFF</span>
                        {% endif %}
                    </div>
<!-- Default Style (White with gradient hover) -->
<button class="quick-view-btn" onclick="quickView({{ product.id }}, event)">
    <i class="fa-regular fa-eye"></i> Quick View
</button>

<!-- Minimal Style -->
<button class="quick-view-btn minimal" onclick="quickView({{ product.id }}, event)">
    <i class="fa-regular fa-eye"></i> Quick View
</button>

<!-- Solid Dark Style -->
<button class="quick-view-btn solid" onclick="quickView({{ product.id }}, event)">
    <i class="fa-regular fa-eye"></i> Quick View
</button>

<!-- Inside product-card div, before or after quick view button -->
<button class="wishlist-btn {% if product.id in user_wishlist_ids %}active{% endif %}" 
        onclick="toggleWishlist({{ product.id }}, event)"
        data-product-id="{{ product.id }}">
    <i class="fa-{% if product.id in user_wishlist_ids %}solid{% else %}regular{% endif %} fa-heart"></i>
</button>
                    <div class="product-info">
                        <h3>{{ product.name }}</h3>
                        <div class="rating">
                            <span class="stars">
                                {% for i in range(5) %}
                                    {% if i < product.rating|int %}
                                        ★
                                    {% else %}
                                        ☆
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <span class="rating-count">({{ product.reviews_count }})</span>
                        </div>
                        <div class="price">
                            <span class="current">₹{{ product.price }}</span>
                            {% if product.compare_price and product.compare_price > product.price %}
                            <span class="original">₹{{ product.compare_price }}</span>
                            <span class="discount">{{ ((product.compare_price - product.price) / product.compare_price * 100)|int }}% OFF</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="no-products">
                    <p>No products found matching your filters.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Category Chips at Bottom -->
    <div class="category-chips">
        <h3>Shop by Category</h3>
        <div class="chips-container">
            {% for category in categories %}
            <a href="{{ url_for('all_products', category=category) }}" class="category-chip">{{ category }}</a>
            {% endfor %}
        </div>
    </div>
</div>

<style>
/* Additional styles */
.products-header h2 {
    display: flex;
    align-items: center;
    gap: 10px;
}

.product-count {
    font-size: 14px;
    font-weight: normal;
    color: #666;
    background: #f0f0f0;
    padding: 3px 10px;
    border-radius: 20px;
}

.no-products {
    grid-column: 1 / -1;
    text-align: center;
    padding: 50px;
    background: white;
    border-radius: 8px;
    color: #666;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Set checkboxes based on URL params
    const categoryParam = urlParams.get('category');
    if (categoryParam) {
        document.querySelectorAll('input[name="category"]').forEach(cb => {
            cb.checked = (cb.value === categoryParam);
        });
    }
    
    const brandParam = urlParams.get('brand');
    if (brandParam) {
        document.querySelectorAll('input[name="brand"]').forEach(cb => {
            cb.checked = (cb.value === brandParam);
        });
    }
    
    const ratingParam = urlParams.get('min_rating');
    if (ratingParam) {
        document.querySelectorAll('input[name="rating"]').forEach(cb => {
            cb.checked = (cb.value === ratingParam);
        });
    }
    
    // Filter functionality
    function applyFilters() {
        let url = '/products?';
        const params = [];
        
        // Categories (get first selected)
        const selectedCats = Array.from(document.querySelectorAll('input[name="category"]:checked'))
            .map(cb => cb.value);
        if (selectedCats.length) {
            params.push('category=' + encodeURIComponent(selectedCats[0]));
        }
        
        // Price
        const minPrice = document.getElementById('min-price').value;
        const maxPrice = document.getElementById('max-price').value;
        if (minPrice) params.push('min_price=' + encodeURIComponent(minPrice));
        if (maxPrice) params.push('max_price=' + encodeURIComponent(maxPrice));
        
        // Brand
        const selectedBrands = Array.from(document.querySelectorAll('input[name="brand"]:checked'))
            .map(cb => cb.value);
        if (selectedBrands.length) {
            params.push('brand=' + encodeURIComponent(selectedBrands[0]));
        }
        
        // Rating
        const selectedRatings = Array.from(document.querySelectorAll('input[name="rating"]:checked'))
            .map(cb => cb.value);
        if (selectedRatings.length) {
            params.push('min_rating=' + encodeURIComponent(selectedRatings[0]));
        }
        
        // Sort
        const sort = document.getElementById('sort-select').value;
        params.push('sort=' + encodeURIComponent(sort));
        
        window.location.href = url + params.join('&');
    }
    
    // Event listeners
    document.querySelectorAll('input[name="category"], input[name="brand"], input[name="rating"]').forEach(cb => {
        cb.addEventListener('change', applyFilters);
    });
    
    document.querySelector('.apply-price').addEventListener('click', applyFilters);
    document.getElementById('sort-select').addEventListener('change', applyFilters);
    
    document.querySelector('.clear-filters').addEventListener('click', function() {
        window.location.href = '/products';
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let activeFilters = {
        categories: [],
        min_price: null,
        max_price: null,
        brands: [],
        min_rating: null,
        sort_by: 'newest'
    };
    
    // Category filters
    document.querySelectorAll('input[name="category"]').forEach(cb => {
        cb.addEventListener('change', function() {
            updateCategoryFilters();
            applyFilters();
        });
    });
    
    // Brand filters
    document.querySelectorAll('input[name="brand"]').forEach(cb => {
        cb.addEventListener('change', function() {
            updateBrandFilters();
            applyFilters();
        });
    });
    
    // Rating filters
    document.querySelectorAll('input[name="rating"]').forEach(cb => {
        cb.addEventListener('change', function() {
            if (this.checked) {
                activeFilters.min_rating = parseInt(this.value);
            } else {
                activeFilters.min_rating = null;
            }
            applyFilters();
        });
    });
    
    // Price filter
    document.querySelector('.apply-price').addEventListener('click', function() {
        const minPrice = document.getElementById('min-price').value;
        const maxPrice = document.getElementById('max-price').value;
        
        activeFilters.min_price = minPrice ? parseFloat(minPrice) : null;
        activeFilters.max_price = maxPrice ? parseFloat(maxPrice) : null;
        
        applyFilters();
    });
    
    // Sort filter
    document.getElementById('sort-select').addEventListener('change', function() {
        activeFilters.sort_by = this.value;
        applyFilters();
    });
    
    // Clear all filters
    document.querySelector('.clear-filters').addEventListener('click', function() {
        // Reset checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        
        // Reset price inputs
        document.getElementById('min-price').value = '';
        document.getElementById('max-price').value = '';
        
        // Reset sort
        document.getElementById('sort-select').value = 'newest';
        
        // Reset active filters
        activeFilters = {
            categories: [],
            min_price: null,
            max_price: null,
            brands: [],
            min_rating: null,
            sort_by: 'newest'
        };
        
        applyFilters();
    });
    
    function updateCategoryFilters() {
        activeFilters.categories = Array.from(
            document.querySelectorAll('input[name="category"]:checked')
        ).map(cb => cb.value);
    }
    
    function updateBrandFilters() {
        activeFilters.brands = Array.from(
            document.querySelectorAll('input[name="brand"]:checked')
        ).map(cb => cb.value);
    }
    
    function applyFilters() {
        // Show loading
        document.getElementById('product-grid').innerHTML = `
            <div class="loading-spinner">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <p>Loading products...</p>
            </div>
        `;
        
        fetch('/api/filter-products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(activeFilters)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('product-grid').innerHTML = data.html;
                document.querySelector('.product-count').textContent = 
                    `(${data.count} items)`;
                
                // Update URL with filters (optional)
                updateURL();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('product-grid').innerHTML = `
                <div class="error-message">
                    <p>Failed to load products. Please try again.</p>
                </div>
            `;
        });
    }
    
    function updateURL() {
        const params = new URLSearchParams();
        
        if (activeFilters.categories.length) {
            params.set('category', activeFilters.categories[0]);
        }
        if (activeFilters.min_price) {
            params.set('min_price', activeFilters.min_price);
        }
        if (activeFilters.max_price) {
            params.set('max_price', activeFilters.max_price);
        }
        if (activeFilters.brands.length) {
            params.set('brand', activeFilters.brands[0]);
        }
        if (activeFilters.min_rating) {
            params.set('min_rating', activeFilters.min_rating);
        }
        params.set('sort', activeFilters.sort_by);
        
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState({}, '', newUrl);
    }
});
</script>
<script>
function applyFilters() {
    let url = '/products?';
    const params = [];
    
    // Category (radio - single value)
    const selectedCategory = document.querySelector('input[name="category"]:checked');
    if (selectedCategory && selectedCategory.value) {
        params.push('category=' + encodeURIComponent(selectedCategory.value));
    }
    
    // Price (unchanged)
    const minPrice = document.getElementById('min-price').value;
    const maxPrice = document.getElementById('max-price').value;
    if (minPrice) params.push('min_price=' + encodeURIComponent(minPrice));
    if (maxPrice) params.push('max_price=' + encodeURIComponent(maxPrice));
    
    // Brand (radio - single value)
    const selectedBrand = document.querySelector('input[name="brand"]:checked');
    if (selectedBrand && selectedBrand.value) {
        params.push('brand=' + encodeURIComponent(selectedBrand.value));
    }
    
    // Rating (radio - single value)
    const selectedRating = document.querySelector('input[name="rating"]:checked');
    if (selectedRating && selectedRating.value) {
        params.push('min_rating=' + encodeURIComponent(selectedRating.value));
    }
    
    // Sort
    const sort = document.getElementById('sort-select').value;
    params.push('sort=' + encodeURIComponent(sort));
    
    window.location.href = url + params.join('&');
}
</script>
{% endblock %}